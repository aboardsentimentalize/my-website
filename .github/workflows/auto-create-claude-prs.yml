name: Auto-create Claude PRs

on:
  push:
    branches:
      - 'claude/*'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Pull Request
        run: |
          echo "Branch: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"

          # Check if PR already exists
          echo "Checking for existing PR..."
          PR_COUNT=$(gh pr list --repo "${{ github.repository }}" --head "${{ github.ref_name }}" --json number --jq 'length' 2>/dev/null || echo "0")

          if [ "$PR_COUNT" != "0" ]; then
            EXISTING_PR=$(gh pr list --repo "${{ github.repository }}" --head "${{ github.ref_name }}" --json number --jq '.[0].number')
            echo "✓ PR already exists: #$EXISTING_PR"
            exit 0
          fi

          echo "No existing PR found, creating new PR..."

          # Get commit info
          TITLE="$(git log -1 --pretty=%s)"
          BODY="$(git log -1 --pretty=%b)"

          # Use title as body if body is empty
          if [ -z "$BODY" ]; then
            BODY="Automated PR for ${{ github.ref_name }}"
          fi

          echo "Title: $TITLE"

          # Create PR (this will fail gracefully if PR already exists)
          if gh pr create \
            --repo "${{ github.repository }}" \
            --title "$TITLE" \
            --body "$BODY" \
            --base main \
            --head "${{ github.ref_name }}" 2>&1 | tee /tmp/pr_output.txt; then
            echo "✓ PR created successfully"
            exit 0
          fi

          # If creation failed, check the error message
          if grep -q "already exists\|duplicate" /tmp/pr_output.txt; then
            echo "✓ PR already exists (detected in error message)"
            exit 0
          fi

          # Final check: maybe PR was created despite error
          PR_COUNT=$(gh pr list --repo "${{ github.repository }}" --head "${{ github.ref_name }}" --json number --jq 'length' 2>/dev/null || echo "0")
          if [ "$PR_COUNT" != "0" ]; then
            EXISTING_PR=$(gh pr list --repo "${{ github.repository }}" --head "${{ github.ref_name }}" --json number --jq '.[0].number')
            echo "✓ PR exists after creation attempt: #$EXISTING_PR"
            exit 0
          fi

          echo "✗ Failed to create PR:"
          cat /tmp/pr_output.txt
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
